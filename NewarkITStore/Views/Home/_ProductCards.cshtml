@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@model List<NewarkITStore.Models.Product>

@{
    var offers = (List<NewarkITStore.Models.Offer>)ViewBag.Offers;
    var status = (string)ViewBag.UserStatus ?? "Regular";
}

@foreach (var product in Model)
{
    var offer = offers?.FirstOrDefault(o => o.ProductId == product.ProductId);
    bool isEligible = status == "Gold" || status == "Platinum";

    <div class="col-md-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                @if (!string.IsNullOrEmpty(product.ImageFileName))
                {
                    <img src="~/images/@product.ImageFileName"
                         class="card-img-top mb-3"
                         style="object-fit: contain; height: 200px;" />
                }

                <h5 class="card-title">@product.Name</h5>
                <h6 class="card-subtitle text-muted mb-2">@product.ProductType?.Name</h6>
                <p class="card-text flex-grow-1">@product.Description</p>

                @if (offer != null && isEligible)
                {
                    var daysLeft = (offer.EndDate - DateTime.Today).Days;

                    <p>
                        <strong>Price:</strong>
                        <span class="text-muted text-decoration-line-through">$@product.RecommendedPrice</span>
                        <span class="text-success fw-bold ms-2">$@offer.OfferPrice</span>
                        <span class="badge bg-success ms-2">Offer!</span>
                    </p>

                    @if (daysLeft > 0)
                    {
                        <p class="text-danger fw-bold">Ends in @daysLeft day@(daysLeft > 1 ? "s" : "")!</p>
                    }
                    else
                    {
                        <p class="text-danger fw-bold">Last day to get this offer!</p>
                    }
                }
                else
                {
                    <p><strong>Price:</strong> $@product.RecommendedPrice</p>
                }

                @if (SignInManager.IsSignedIn(User))
                {
                    <form asp-controller="Basket" asp-action="Add" method="post">
                        <input type="hidden" name="productId" value="@product.ProductId" />
                        <button type="submit" class="btn btn-outline-primary w-100">Add to Basket</button>
                    </form>
                }
                else
                {
                    <form method="get" asp-area="Identity" asp-page="/Account/Login">
                        <input type="hidden" name="ReturnUrl" value="/Home" />
                        <button type="submit" class="btn btn-outline-primary w-100">Add to Basket</button>
                    </form>
                }
            </div>
        </div>
    </div>
}
